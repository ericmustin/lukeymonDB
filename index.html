<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
</head>

<body>
    <p>
        <form id="calc" action="index.html">
            <input type="text" id="symbol" value="QQQ" />
            <input type="submit" value="Search">
        </form>
        <select name="listOfSymbols" id="options" multiple="multiple"></select>
    </p>
    <div id="title"></div>
    <div id="tester" style="width:90%;height:500px;"></div>
</body>
<script type="text/javascript">
$(document).ready(function() {
    var symbolList = [];
    $.get("http://127.0.0.1:3000/").done(function(response, error) {
        symbolList = response.data.sort();
        symbolList.forEach(function(newSymbol) {
            var opt = document.createElement('option');
            opt.text = newSymbol;
            opt.value = newSymbol;
            opt.class = 'option';
            $('#options').append(opt, null);
        });
    });

    $('#options').on('change', function() {
        var x = $('option:selected').val();
        $('#symbol').val(x);
    });

    $('#calc').on('submit', function(event) {
        event.preventDefault();
        var data = $('#symbol')
        $.post("http://127.0.0.1:3000/api", {
            symbol: data[0].value
        }).done(function(response, errorHandler) {
            if (errorHandler !== 'success') {
                console.log('error');
                console.log(errorHandler);
            } else {
                if (response.error) {
                    console.log("response is: ", response.error);
                } else {
                    var response = JSON.parse(response);

                    var data = [{
                        x: response.outputIds,
                        y: response.outputPrices,
                        type: "scatter"
                    }];
                    var axisXTemplate = {
                        showgrid: false,
                        zeroline: false,
                        nticks: 1,
                        showline: true,
                        title: "Time",
                        mirror: 'all'
                    };
                    var axisYTemplate = {
                        showgrid: false,
                        zeroline: true,
                        nticks: 10,
                        showline: true,
                        title: "Price",
                        mirror: 'all'
                    };
                    var layout = {
                        xaxis: axisXTemplate,
                        yaxis: axisYTemplate
                    };
                    $('#tester').replaceWith('<div id="tester" style="width:90%;height:500px;"></div>');
                    TESTER = document.getElementById('tester');
                    Plotly.plot(TESTER, data, layout);

                    TITLE = document.getElementById('title');

                    TITLE.innerHTML = "Last Trade: " +
                        response.topTrade.Symbol +
                        " " +
                        response.topTrade.Expiration +
                        " " +
                        response.topTrade.Strike +
                        " r/c traded " +
                        response.topTrade.Price +
                        " " + response.topTrade.Type +
                        " " +
                        response.topTrade.Size +
                        "x. Average Price: " +
                        response.avgPx.toFixed(4) +
                        ". Total Size: " +
                        response.totalSize +
                        "x";
                }
            }
        });
    });
});
</script>

</html>
